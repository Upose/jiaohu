<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="__DOCLAY__/plugins/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="__CSS__/ProjectPlan.css" media="all">
    <script src="__STATIC__/jquery-2.0.3.min.js"></script>
</head>

<body>
    <div class="main">
        <h2>项目计划内容</h2>
        <!-- <form class="layui-form" action=""> -->
            <section class="info">
                <div class="infoCont">
                    <div class="infoLeft">
											<div class="timeSelect">
													<label class="name">项目名称：</label>
													<input type="text" name="title" id="itemName" lay-verify="required" required="required" placeholder="请输入项目名称" class="layui-input">    
											</div>
											<div class="timeSelect">
													<label class="name">开始日期：</label>
													<input type="text"  required="required" class="layui-input" id="startTime">
											</div>                    
                    </div>
                    <div class="infoRight">
                            <div class="timeSelect">
                                <label class="name">所属阶段：</label>
                                <select name="stage" id='stageCont' lay-verify="" class="pro_select">
                                    <option value="01" selected>初始阶段</option>
                                    <option value="02">实施阶段</option>
                                    <option value="03">交付阶段</option>
                                </select>
                            </div>
                        <div class="timeSelect">
                            <label class="title-stage">变更阶段原因：</label>
                            <input type="text" name="title" id="itemRate" lay-verify="required" required="required" placeholder="请输入工作进度" class="layui-input">
                        </div>
                    </div>
                </div>

            </section>
            <section class="this-work">
                <h3>计划内容</h3>
                <button class="layui-btn addThisWork">添加</button>
                <table class="layui-table">
                    <colgroup>
                        <col width="100">
                        <col width="100">
                        <col>
                        <col width="100">
                        <col>
                        <col>
                    </colgroup>
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>任务名称</th>
                            <th>任务类型</th>
                            <th>内容描述</th>
                            <th>负责人</th>
                            <th>完成率</th>
														<th>问题描述</th>
														<th>参与人</th>
														<th>计划完成时间</th>
														<th>变更完成时间</th>
														<th>实际完成时间</th>
														<th>处理状态</th>
														<th>预期原因</th>
														<th>是否重大事件</th>
														<th>重大事件原因</th>
                        </tr> 
                    </thead>
                    <tbody id="thisWorkList"></tbody>
                </table>
            </section>
            
            <div class="submitInfo">
                <button type="button" class="layui-btn" id="submitWorkly" lay-submit lay-filter="formDemo">提交</button>
            </div>
       <!-- </form> -->
    </div>
</body>
<script src="__DOCLAY__/plugins/layui/layui.js"></script>
<script>
    $(function(){
        // 注册时间选择器
        layui.use('laydate', function(){
            var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#startTime' //开始事件
            });
            laydate.render({
                elem: '#endTime' //结束时间
            });
            laydate.render({
                elem: '#stageTime' //截止时间
            });
        });

        // 注册from解决下拉选择器样式失效问题
        layui.use('form', function(){
            var form = layui.form;
            // 解决form表单跳转问题
            form.on('submit', function(data){
                return false
            })
            form.render();
        });

        var thisWorkId = 0 // 本周任务序号
        var nextWorkId = 0 // 下周任务序号
        var thisList = $('#thisWorkList').html() // 本周任务列表
        var nextList = $('#nextWorkList').html() // 下周任务列表
        var workInfo = {} // 基本信息
        var thisWorkData = [] // 本周任务数据*
        var nextWorkData = [] // 下周计划数据
        // 添加本周任务 
        $('.addThisWork').on('click',function(){
            layer.open({
                type: 1,
                title: false,
                closeBtn: 1,
                shadeClose: true,
                anim:5,
                isOutAnim:true,
                content: '<div class="form-addNextWork">'+
                            '<h4>添加本周任务</h4>'+
                            '<form class="layui-form" action="">'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">工作描述：</label>'+
                                    '<div class="layui-input-block">'+
                                        '<input type="text" name="title" required id="workDep" lay-verify="required" placeholder="请输入工作内容" autocomplete="off" class="layui-input">'
                                    +'</div>'
                                +'</div>'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">完成率：</label>'+
                                    '<div class="layui-input-block">'+
                                        '<input type="text" name="title" required id="workRate" lay-verify="required" placeholder="请输入计划完成程度" autocomplete="off" class="layui-input">'+
                                    '</div>'+
                                '</div>'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">完成内容：</label>'+
                                    '<div class="layui-input-block">'+
                                        '<input type="text" name="title" required id="finishCont" lay-verify="required" placeholder="请输入计划完成程度" autocomplete="off" class="layui-input">'+
                                    '</div>'+
                                '</div>'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">状态：</label>'+
                                    '<div class="layui-input-block">'+
                                        '<select name="state" id="workState" lay-verify="">'+
                                            '<option value="01" selected>进行中</option>'+
                                            '<option value="02">已完成</option>'+
                                            '<option value="03">已关闭</option>'+
                                        '</select>'+
                                    '</div>'+
                                '</div>'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">备注：</label>'+
                                    '<div class="layui-input-block">'+
                                        '<input type="text" name="title" id="remark" placeholder="请输入备注" autocomplete="off" class="layui-input">'+
                                    '</div>'+
                                '</div>'+
                                '<button class="layui-btn" id="addWork1">添加</button>'+
                            '</form>'+
                        '</div>'
            });            
            layui.use('form', function(){
                var form = layui.form;
                // 解决form表单跳转问题
                form.on('select', function(data){
                    if (data.value == 03) {
                        $('#remark').attr('required','required')
                    }
                }); 
                form.on('submit', function(data){
                    return false
                })
                form.render();
            });
            $('#addWork1').on('click',function(){
                var workDep = $('#workDep').val()
                var workRate = $('#workRate').val()
                var finishCont = $('#finishCont').val()
                var workStateText = $("#workState option:selected").text();
                var workStateId =  $("#workState").val();
                var remark = $('#remark').val()
                var thisWorkItem = {}
                if (workStateId == 03) {
                    if (workDep !== '' && workRate !== '' && finishCont !== '' && workState !== '' && remark !== '') {
                        thisWorkId = thisWorkId+1
                        thisWorkItem.weekly_id = thisWorkId
                        thisWorkItem.task_content = workDep
                        thisWorkItem.finish_status = workRate
                        thisWorkItem.finish_content = finishCont
                        thisWorkItem.state = workStateText
                        thisWorkItem.remark = remark
                        thisWorkData.push(thisWorkItem)
                        thisList += '<tr>'+
                                        '<td>'+ thisWorkId +'</td>'+
                                        '<td>'+ workDep +'</td>'+
                                        '<td>'+ workRate +'</td>'+
                                        '<td>'+ finishCont +'</td>'+
                                        '<td>'+ workStateText +'</td>'+
                                        '<td>'+ remark +'</td>'+
                                    '</tr>'
                        $('#thisWorkList').html(thisList);
                        layer.close(layer.index);
                    }
                }  else {
                    if  (workDep !== '' && workRate !== '' && finishCont !== '' && workState !== '') {
                        if (remark == '') {
                            remark = '无'
                        }
                        thisWorkId = thisWorkId+1
                        thisWorkItem.weekly_id = thisWorkId
                        thisWorkItem.task_content = workDep
                        thisWorkItem.finish_status = workRate
                        thisWorkItem.finish_content = finishCont
                        thisWorkItem.state = workStateText
                        thisWorkItem.remark = remark
                        thisWorkData.push(thisWorkItem)
                        thisList += '<tr>'+
                                        '<td>'+ thisWorkId +'</td>'+
                                        '<td>'+ workDep +'</td>'+
                                        '<td>'+ workRate +'</td>'+
                                        '<td>'+ finishCont +'</td>'+
                                        '<td>'+ workStateText +'</td>'+
                                        '<td>'+ remark +'</td>'+
                                    '</tr>'
                        $('#thisWorkList').html(thisList);
                        layer.close(layer.index);
                    }
                }
            });
        })
        // 添加下周计划
        $('.addNextWork').on('click',function(){
            layer.open({
                type: 1,
                title: false,
                closeBtn: 1,
                shadeClose: true,
                anim:5,
                isOutAnim:true,
                content: '<div class="form-addNextWork">'+
                            '<h4>添加下周计划</h4>'+
                            '<form class="layui-form" action="">'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">工作内容：</label>'+
                                    '<div class="layui-input-block">'+
                                        '<input type="text" name="title" required id="workCont" lay-verify="required" placeholder="请输入工作内容" autocomplete="off" class="layui-input">'
                                    +'</div>'
                                +'</div>'+
                                '<div class="layui-form-item">'+
                                    '<label class="layui-form-label">计划完成：</label>'+
                                    '<div class="layui-input-block">'+
                                        '<input type="text" name="title" required id="workStage" lay-verify="required" placeholder="请输入计划完成程度" autocomplete="off" class="layui-input">'+
                                    '</div>'+
                                '</div>'+
                                '<button class="layui-btn" id="addWork2">添加</button>'+
                            '</form>'+
                        '</div>'
            });
            $('#addWork2').on('click',function(){
                var workCont = $('#workCont').val()
                var workStage = $('#workStage').val()
                var nextWorkItem = {}
                if (workCont !== '' && workStage !== '') {
                    nextWorkId = nextWorkId+1
                    nextWorkItem.weekly_id = nextWorkId
                    nextWorkItem.task_content = workCont
                    nextWorkItem.finish_plan = workStage
                    nextWorkData.push(nextWorkItem)
                    nextList += '<tr>'+
                                '<td>' + nextWorkId+ '</td>'+
                                '<td>' +workCont  + '</td>'+
                                '<td>'+workStage+'</td>'+
                            '</tr>'
                    $('#nextWorkList').html(nextList);
                    layer.close(layer.index);
                }
            })
        })

        // 采集表单数据并发送
        $('#submitWorkly').on('click',function(){
            workInfo.weekly_stime = $('#startTime').val() // 获取开始时间
            workInfo.weekly_etime = $('#endTime').val() // 获取结束时间
            workInfo.pro_name =  $('#itemName').val() // 获取项目名称
            workInfo.stage = $('#stageCont option:selected').text() // 获取所属阶段
            workInfo.pro_schedule = $('#itemRate').val() // 获取工作进度
            workInfo.stageenddate = $('#stageTime').val() // 获取阶段截止日期
            if (workInfo.weekly_stime == '' || workInfo.weekly_etime == '' 
                || workInfo.pro_name == '' || workInfo.pro_schedule == '' 
                || workInfo.stageenddate == '' || thisList == '')
            {
                layer.msg('请填写完整信息后提交', {icon: 5});
            } else {
                // console.log(workInfo)
                $.ajax({
                    cache: false,
                    type: "post",
                    url: "{:U('ProjectweekReport/weekInsert')}",
                    dataType: "json",
                    data:{
                        workInfo:workInfo,
                        thisWorkData:thisWorkData,
                        nextWorkData:nextWorkData
                    }
                })
                // 重置信息
                $('#startTime').val('')
                $('#endTime').val('')
                $('#itemName').val('')
                $('#stageCont').val('')
                $('#itemRate').val('')
                $('#stageTime').val('')
                thisWorkId = 0 // 本周任务序号
                nextWorkId = 0 // 下周任务序号
                thisList = $('#thisWorkList').html('') // 本周任务列表
                nextList = $('#nextWorkList').html('') // 下周任务列表
                workInfo = {} // 基本信息
                thisWorkData = [] // 本周任务数据
                nextWorkData = [] // 下周计划数据
            }
        });
    })
</script>
</html>