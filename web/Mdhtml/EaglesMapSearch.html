<!DOCTYPE html>
<html>
<head>
<title>Eagles之地图搜索</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<h1>Eagles之地图搜索</h1>
<p><font size="4"><strong>1.1方案背景</strong></font></br></p>
<p><strong>Q：如何使用Eagles实现和附近的人实时分享idea？</strong></br>
<img src="https://i.imgur.com/vvfUwVH.jpg" /></p>
<p>&#160; &#160; &#160; &#160;具体来说，每个区域会有很多用户参与分享，需要对范围内的感兴趣用户进行搜索，该如何让每个用户都能准确地和周围的人分享idea呢？</br>
&#160; &#160; &#160; &#160;这也是Eagles地图搜索功能设计之初关注的一个方面。<br></p>
<p><font size="4"><strong>1.2解决方案</strong></font></br></p>
<p>&#160; &#160; &#160; &#160;以下详解如何利用Eagles提供的地图搜索功能来进行搜索：</br></p>
<p>&#160; &#160; &#160; &#160;<strong>1.21建立索引</strong></br></p>
<p>&#160; &#160; &#160; &#160;  &#160;  &#160;<strong>第一步：利用Eagles对数据建立索引</strong> </br>
&#160; &#160; &#160; &#160;  &#160;  &#160;基于Eagles内置Geo字段支持，只要文档中包含空间信息字段，即可使用Eagles搜索API进行空间搜索、距离搜索、范围搜索、空间统计等高级功能。</br>
&#160; &#160; &#160;  &#160;  &#160; &#160;利用这一点，Eagles可以先索引所有参与用户的相关数据，这组数据可能包括但不限于以下字段：</br></p>
<p>&#160; &#160; &#160; &#160;  &#160;  &#160;UserID（系统给用户设置的UUID）-----字符型</br>
&#160; &#160; &#160; &#160;  &#160;  &#160;Behavior(用户进行操作的行为ID)-----字符型，也可作为Eagles搜索中的UUID</br>
&#160; &#160; &#160; &#160;  &#160;  &#160;Content（ideal content）-----字符型，Eagles支持全文搜索对关键词进行过滤查询</br>
&#160;&#160;&#160;&#160;&#160;&#160;Location（地理坐标）----地理坐标，eagles地图搜索的基点</br>
&#160; &#160; &#160; &#160;  &#160;  &#160;ShareOn(是否参与分享)----bool型，eagles可利用过滤匹配对shareoff文档进行过滤</br></p>
<p>&#160; &#160; &#160; &#160;  &#160;  &#160;<strong>Eagles具体的创建如下：</strong></br></p>
<p><img src="https://i.imgur.com/gKb2Msj.png" /></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;eagles插入数据简单快捷，当往一个索引内添加数据时，eagles将自动检测数据的结构和类型,如不存在则新建字段匹配它，并默认检索这些数据。当然，你可以自定义这些数据是如何接受索引的。</br>
&#160;&#160;&#160;&#160;&#160;&#160;这里，可以模拟已经索引进以下数据：</br></p>
<p><img src="https://i.imgur.com/oD2gaeS.png" /></p>
<p>&#160;&#160;&#160;&#160;&#160;&#160;如上图:<br>
&#160;&#160;&#160;&#160;&#160;&#160;第一列为操作编号；<br>
&#160;&#160;&#160;&#160;&#160;&#160;第二列为内容（可以注意到，这里的多条内容重复含有相同关键字—“月全食”）；<br>
&#160;&#160;&#160;&#160;&#160;&#160;第三列为地址坐标（Eagles根据文档包含的地理空间字段来提取）；<br>
&#160;&#160;&#160;&#160;&#160;&#160;第四列为分享判定；<br>
&#160;&#160;&#160;&#160;&#160;&#160;第五列为UserID。<br>
&#160; &#160; &#160; &#160;<strong>1.22地图搜索</strong></br></p>
<p>&#160; &#160; &#160; &#160; &#160;&#160;<strong>第二步：利用Eagles的地图检索对范围内的文档进行过滤</strong> </br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;在利用Eagles完成索引的建立后，会得到大量的有关用户提交的数据。接下来，需要借助Eagles地图搜索功能的支持。</p>
<p><img src="https://i.imgur.com/HhfBHn1.jpg" /></p>
<p>用户虽然是一个个孤立的点，但是，对于任意的一个文档，Eagles都可基于文档包含的地理空间字段来进行地图搜索，继而寻找到一定范围内符合条件的相关文档，实现分享与搜索。</br>
为了实现对附近的人进行搜索，则会利用到Eagles的范围搜索功能。</br>
范围搜索实际上是基于原点地理坐标+范围大小的范围搜索。查询时，需要输入原点的坐标地址（坐标通常需要精确到小数点后6位，这里简化了数据），以及查询的距离（范围）。具体查询语句如下：<br></p>
<pre><code>{
  &quot;query&quot;: {
    &quot;filtered&quot;: {
      &quot;filter&quot;: {
        &quot;geo_distance&quot;: {
          &quot;distance&quot;: &quot;1km&quot;,
          &quot;Location &quot;: {
            &quot;lat&quot;: 121.48,
            &quot;lon&quot;: 31.22 
          }
        }
      }
    }
  }
}
</code></pre>

<p>&#160; &#160;&#160; &#160;Body中，distance即为搜索范围（可变，可根据需求给出不同范围，这里设置为1km）,Location则是原点坐标(这里设置坐标为121.48,31.22)，给出不同的distance时，搜索区域都不相同，结果也会不同。</p>
<p><img src="https://i.imgur.com/2q4072d.png" /></p>
<p><img src="https://i.imgur.com/dnSwKdY.jpg" /><br></p>
<p>&#160; &#160; &#160; &#160;<strong>1.23地图过滤搜索</strong></br></p>
<p>当然，Eagles不仅提供单一的地图搜索，也可对结果进行过滤，例如，对含有指定关键词的idea进行过滤。</br>
像前面提到的，多条数据的content中都含有“月全食”关键字，如果需要只反馈含有该关键词的搜索，那么就需要对搜索结果进行过滤，需要复合语句支撑,可以这样写：</br></p>
<p><img src="https://i.imgur.com/BjGm7Ea.png" /></p>
<p>实际上用到的语句为：</p>
<pre><code>{
  &quot;query&quot;: {
    &quot;filtered&quot;: {
          &quot;query&quot;: {
            &quot;match&quot;: { 
                &quot;Content&quot;: &quot;月全食&quot; 
                }
            },
      &quot;filter&quot;: {
        &quot;geo_distance&quot;: {
          &quot;distance&quot;: &quot;0.1km&quot;,
          &quot;Location &quot;: {
            &quot;lat&quot;: 121.48,
            &quot;lon&quot;: 31.22 
          }
        }
      }
    }
  }
}
</code></pre>

<p>其实只是新增了match匹配语句，搜索结果显示仍然有2个结果满足。结果的content中也验证了查询结果，确实含有关键字“月全食”。<br>
不知道有没有发现，第四列字段shareon被放空了，搜索没有设置对shareon=0的结果进行过滤（事实上判定不该在查询中这样做，这里只是为了验证多重查询条件存在时的搜索情况而已）。<br>
所以，我们还需要对查询语句中对shareon=0的结果过滤，那么可以这样搜索：<br></p>
<p><img src="https://i.imgur.com/uyFH802.png" /></p>
<p>Body部分为：</p>
<pre><code>{
&quot;query&quot;:{
 &quot;filtered&quot;: {
        &quot;query&quot;: {
            &quot;match&quot;: {
                 &quot;Content&quot;: &quot;月全食&quot; 
                     }
                 },
      &quot;filter&quot;: {
          &quot;bool&quot;: {
             &quot;must&quot;: { 
                 &quot;geo_distance&quot;: {
                      &quot;distance&quot;: &quot;0.1km&quot;,
                      &quot;Location &quot;: {
                             &quot;lat&quot;: 121.48,
                              &quot;lon&quot;: 31.22 
                                    }
                                  }
                      },
            &quot;must_not&quot;: { 
                 &quot;term&quot;: {
                   &quot;ShareOn&quot;: 0
                          }
                        }
                     }
                  }
             }
      }
}
</code></pre>

<p>由于加入了带bool的过滤器查询，使得查询条件可以有更加多的限制。这里额外限制了shareon 必须不为0,即不被分享的不允许搜索到，从而使得查询结果屏蔽了不符合条件的点，使得结果更加具有方向性。（更加复杂的查询语句还是要参考开发文档）<br>
仔细看的话会发现，其实在查询过程中，也或多或少会使用到Eagles对全文搜索功能（这点注重会在其他文档中体现，这也是Eagles另外的应用方向），只不过这里数据量较小还无法看出优势罢了。<br>
附：Eagles对提供的地图检索功能远不止范围检索，还包括区域检索，周边检索，多边形检索，本地检索，热力图等。<br></p>
<p><font size="4"><strong>1.3案例总结</strong></font></br></p>
<p>&#160; &#160; &#160; &#160;为了更加形象的说明Eagles地图搜索的优势，这里选用了“附近的人”这样的案例。主要还是从建立，存储，查找几个方面结合Eagles的实际进行了分析。对过程中需要利用到的Eagles主要环节进行了说明，也注重强调了Eagles的一些特点。</p>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
